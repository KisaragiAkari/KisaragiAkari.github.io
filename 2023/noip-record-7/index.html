<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn-us.imgs.moe/2023/01/26/63d1eb385309a.png"><link rel="icon" href="https://cdn-us.imgs.moe/2023/01/26/63d1eb385309a.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#003153"><meta name="author" content="如月あかり"><meta name="keywords" content=""><meta name="description" content="专门放一些不大可能会考的计数题，长期更新。 大约是输入的只有问题规模，输出的只有相应方案数。 luogu6561 [SBCOI2020] 人 两两不相邻这个条件不是很容易搞。 考虑把 \([1,2m]\) 分成 \(m\) 个数对，形如 \((\text{odd},\text{even})\)，其中 $ +1 = $ 把选择了 \(\text{odd}\) 的数对称为A，选择了 \("><title>「NOIP Record」#7 计数杂题 (2) - Kisaragi&#39;s blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"yozora0908.top",root:"/",version:"1.9.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"#"},progressbar:{enable:!0,height_px:3,color:"#0076FF",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:null,onlypost:!0,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!1,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.1.0"><link rel="alternate" href="/atom.xml" title="Kisaragi's blog" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kisaragi&#39;s blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn-us.imgs.moe/2023/02/02/63db75d1e0be8.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.2)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">「NOIP Record」#7 计数杂题 (2)</span></div><div class="mt-3"></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">「NOIP Record」#7 计数杂题 (2)</h1><div class="markdown-body"><p>专门放一些不大可能会考的计数题，长期更新。</p><p>大约是输入的只有问题规模，输出的只有相应方案数。</p><h2 id="luogu6561-sbcoi2020-人">luogu6561 [SBCOI2020] 人</h2><p>两两不相邻这个条件不是很容易搞。</p><p>考虑把 <span class="math inline">\([1,2m]\)</span> 分成 <span class="math inline">\(m\)</span> 个数对，形如 <span class="math inline">\((\text{odd},\text{even})\)</span>，其中 $ +1 = $</p><p>把选择了 <span class="math inline">\(\text{odd}\)</span> 的数对称为<code>A</code>，选择了 <span class="math inline">\(\text{even}\)</span> 的数对称为<code>B</code>，没有选择的称为<code>C</code>。那么问题等价于有多少个只有<code>A</code>，<code>B</code>，<code>C</code>的字符串，满足有 <span class="math inline">\(a\)</span> 个<code>A</code>，<span class="math inline">\(b\)</span> 个<code>B</code>和 <span class="math inline">\(m-a-b\)</span> 个<code>C</code>，且不存在子串<code>BA</code>。</p><p>由于<code>B</code>与<code>C</code>没有限制，所以可以任意安排，只要在 <span class="math inline">\(m-a\)</span> 个里面钦定 <span class="math inline">\(b\)</span> 个<code>B</code>即可，方案 <span class="math inline">\(\binom{m-a}{b}\)</span>。</p><p>接着要插入<code>A</code>，除了在 <span class="math inline">\(b\)</span> 个<code>B</code>后面，其他位置均可，方案 <span class="math inline">\(\binom{m-b}{a}\)</span>。</p><p>因此答案为 <span class="math display">\[ \binom{m-a}{b} \binom{m-b}{a} \]</span> 其实映射到不允许子串<code>BA</code>这一步，就没有什么难的了。</p><p>而如果没有做到映射这一步，那么推理相当痛苦啊。</p><h2 id="luogu8594-kdoi-02一个仇的复">luogu8594 「KDOI-02」一个仇的复</h2><p>能用到的只有 <span class="math inline">\(1 \times x\)</span> 与 <span class="math inline">\(2 \times 1\)</span> 的矩形。</p><p>先不关心后者，考虑只用前者的方案数。设一共用 <span class="math inline">\(k\)</span> 个举行铺满 <span class="math inline">\(2 \times m\)</span> 的网格。</p><p>枚举使用个数，如果第一行用了 <span class="math inline">\(i\)</span> 个，那么第二行就要用 <span class="math inline">\(k-i\)</span> 个，每一行内部都是一个经典问题 <span class="math display">\[ \sum_{i=1}^{k-1} \binom{m-1}{i-1} \binom{m-1}{k-i-1} = \sum_{i=0}^{k-2} \binom{m-1}{i}\binom{m-1}{k-i-2} \]</span> 根据范德蒙德卷积可以知道这个就是 <span class="math display">\[ \binom{2m-2}{k-2} \]</span> 然后就是用若干 <span class="math inline">\(2 \times 1\)</span> 的矩形把原问题分割成若干上述问题。</p><p>枚举把 <span class="math inline">\(2 \times n\)</span> 的网格分成 <span class="math inline">\(i\)</span> 段，使用了 <span class="math inline">\(j\)</span> 个 <span class="math inline">\(2 \times 1\)</span> 的矩形</p><p>划分方式就是某问题，方案数 <span class="math display">\[ \binom{j+1}{i} \]</span> 还有 <span class="math inline">\(n-j\)</span> 个位置分给 <span class="math inline">\(i\)</span> 段 <span class="math display">\[ \binom{n-j-1}{i-1} \]</span> 最后是把 <span class="math inline">\(k-j\)</span> 个矩形填满 <span class="math inline">\(i\)</span> 段，设第 <span class="math inline">\(l\)</span> 段大小为 <span class="math inline">\(2 \times a_l\)</span>，用 <span class="math inline">\(b_l\)</span> 个矩形 <span class="math display">\[ \sum_{\sum_{l=1}^i b_l = k-j} \prod_{p=1}^i \binom{2a_p -2}{b_p - 2} \]</span> 发现是一个扩展后的范德蒙德卷积，根据组合意义得到上式即为 <span class="math display">\[ \binom{2\sum_{p=1}^i a_p - 2i}{\sum_{p=1}^i b_p - 2i} = \binom{2(n-j)-2i}{k-j-2i} \]</span> 因此答案为 <span class="math display">\[ \sum_{i=1}^k \sum_j^{r} \binom{j+1}{i}\binom{n-j-1}{i-1}\binom{2(n-j)-2i}{k-j-2i} \]</span></p><p>直接枚举 <span class="math inline">\(i,j\)</span> 显然不能接受，注意到如果 <span class="math inline">\(k-j-2i&lt;0\)</span>，那么没有贡献，再综合一下其他的边界，对于每个 <span class="math inline">\(i\)</span> 都能找到一个上界 <span class="math inline">\(r\)</span>，满足 <span class="math inline">\(r&lt;k\)</span>。所以复杂度为 <span class="math inline">\(O(n+k^2)\)</span></p><h2 id="abc242f-black-and-white-rooks">ABC242F Black and White Rooks</h2><p>看起来像是某经典问题的扩展（？</p><p>不是很容易直接做。</p><p>考虑每一种合法方案必然使得黑车与白车所占用的行与列无交，所以答案可以表示为 <span class="math display">\[ \sum_{i=1}^n \sum_{j=1}^{n-i}\sum_{k=1}^m\sum_{l=1}^{m-k} \binom{n}{i}\binom{n-i}{j}\binom{m}{k}\binom{m-k}{l} f_B(i,k)f_W(j,l) \]</span> 一开始的思路被局限到两重循环的枚举上了。</p><p>其中 <span class="math inline">\(f_k(i,j)\)</span> 表示用 <span class="math inline">\(k\)</span> 个车恰好放满 <span class="math inline">\(i\)</span> 行与 <span class="math inline">\(j\)</span> 列的方案数。</p><p>考虑如何求出。</p><p><span class="math inline">\(\texttt{solution 1}\)</span></p><p>显然可以容斥。</p><p>存在至少 <span class="math inline">\(i\)</span> 行 <span class="math inline">\(j\)</span> 列上没有车的方案数显然是 <span class="math display">\[ \binom{n}{i}\binom{m}{j}\binom{(n-i)(m-j)}{k} \]</span> 带上一个 <span class="math inline">\((-1)^{i+j}\)</span> 的系数。</p><p><span class="math inline">\(\texttt{solution 2}\)</span></p><p>也可以换一种思路。 <span class="math display">\[ f_k(n,m) = \binom{nm}{k} - \sum_{i=1}^n\sum_{j=1 \texttt{ and } (i,j) \neq (n,m)}^m \binom{n}{i}\binom{m}{j}f_k(i,j) \]</span></p><ul><li>容斥这个东西，尽量不要考虑在整体思路建立起来之前。</li><li>计数题，不要那么吝惜复杂度。毕竟有很多优化方法。适当地放宽计数的限制。</li><li>不要不经过思考就往自己知道的模型上靠。必须改掉这个习惯。</li></ul><h2 id="cf1342e-placing-rooks">CF1342E Placing Rooks</h2><p>同样是关于车的。</p><p>每个点都在车的攻击范围内，说明要么每一行都有车，要么每一列都有车。当 <span class="math inline">\(k \neq 0\)</span> 时二者不能同时存在。</p><p>可以钦定每一行都有车，求出的方案数的 <span class="math inline">\(2\)</span> 倍即为答案。</p><p>设 <span class="math inline">\(f_i\)</span> 为恰好放 <span class="math inline">\(i\)</span> 个攻击型车的方案数，<span class="math inline">\(g_i\)</span> 为至少。</p><p>不难发现只要钦定所有车都在 <span class="math inline">\(n-i\)</span> 列即可。 <span class="math display">\[ g_i = \binom{n}{n-i}(n-i)^n \]</span></p><p><span class="math display">\[ g_k = \sum_{i=k}^n \binom{i}{k} f_i \]</span></p><p><span class="math display">\[ f_k = \sum_{i=k}^n (-1)^{i-k} \binom{i}{k} g_i \]</span></p><h2 id="cf1794d-counting-factorizations">CF1794D Counting Factorizations</h2><p>考虑这样一个事实：如果确定了 <span class="math inline">\(n\)</span> 个质因数，那么方案数就是剩下 <span class="math inline">\(n\)</span> 个指数做多重集全排列。</p><p>由于每个质因数只能出现一次，所以设 <span class="math inline">\(P\)</span> 为 <span class="math inline">\(A\)</span> 中的不同质数集合，<span class="math inline">\(|P|=m\)</span>。问题转化为求在 <span class="math inline">\(P\)</span> 中选择 <span class="math inline">\(n\)</span> 个数相对应的多重集全排列之和。</p><p>若 <span class="math inline">\(m&lt;n\)</span>，那么无解，因为必须满足有 <span class="math inline">\(n\)</span> 个质因数。</p><p>若 <span class="math inline">\(m=n\)</span>，那么答案就是</p><p><span class="math display">\[ \frac{(2n-m)!}{\prod_{i=1}^{2n} (cnt_{A_i}!)} \]</span></p><p>其中 <span class="math inline">\(cnt_{A_i}\)</span> 表示 <span class="math inline">\(A_i\)</span> 在 <span class="math inline">\(A-P\)</span> 中出现的次数。</p><p>若 <span class="math inline">\(m&gt;n\)</span>，那么就是要把 <span class="math inline">\(m-n\)</span> 个数放到指数集合中，由于放哪些数会影响全排列的值，所以考虑用 DP 求所有合法的全排列的和。</p><p>设 <span class="math inline">\(f_{i,j}\)</span> 表示考虑前 <span class="math inline">\(i\)</span> 个数，已经选了 <span class="math inline">\(j\)</span> 个，<span class="math inline">\(f_{0,0}\)</span> 就是上面那个式子。</p><p>如果不选，直接继承 <span class="math inline">\(f_{i-1,j}\)</span>。如果选，就会让指数集合增大 <span class="math inline">\(1\)</span>，且 <span class="math inline">\(P_i\)</span> 相应的集合增大 <span class="math inline">\(1\)</span>，因此</p><p><span class="math display">\[ f_{i,j} = f_{i-1,j} + [j&gt;0] \Big(f_{i-1,j-1} \cdot \frac{2n-m+j}{cnt_{P_i}+1} \Big) \]</span></p><p>答案 <span class="math inline">\(f_{m,m-n}\)</span>。</p><p>貌似可以多项式优化。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CPY(a,b) memcpy(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">4050</span>, M=<span class="hljs-number">1e6</span>+<span class="hljs-number">5</span>, mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n, m, facn, nn, D, a[N], p[N], cnt[M], f[N][N/<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> tot, pr[M];<br><span class="hljs-type">bool</span> v[M], mp[M], mpp[M];<br><span class="hljs-type">int</span> fac[N], inv[N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fp</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	<span class="hljs-type">int</span> c=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;a=<span class="hljs-number">1ll</span>*a*a%mod,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=<span class="hljs-number">1ll</span>*c*a%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">1e6</span>;++i) &#123;<br>		<span class="hljs-keyword">if</span>(!v[i]) pr[++tot]=i;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=tot&amp;&amp;i*pr[j]&lt;=<span class="hljs-number">1e6</span>;++j) &#123;<br>			v[i*pr[j]]=<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">if</span>(i%pr[j]==<span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>	fac[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2</span>*n;++i) fac[i]=<span class="hljs-number">1ll</span>*fac[i<span class="hljs-number">-1</span>]*i%mod;<br>	inv[<span class="hljs-number">2</span>*n]=<span class="hljs-built_in">fp</span>(fac[<span class="hljs-number">2</span>*n],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>*n<span class="hljs-number">-1</span>;i;--i) inv[i]=<span class="hljs-number">1ll</span>*inv[i+<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)%mod; <br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">rev</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>&#123; <span class="hljs-keyword">return</span> fac[x<span class="hljs-number">-1</span>]*inv[x]%mod; &#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2</span>*n;++i) a[i]=<span class="hljs-built_in">read</span>(), ++cnt[a[i]];<br>	<span class="hljs-built_in">init</span>();<br>	D=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2</span>*n;++i) &#123;<br>		<span class="hljs-keyword">if</span>(a[i]!=<span class="hljs-number">1</span>&amp;&amp;!v[a[i]]&amp;&amp;!mp[a[i]]) mp[a[i]]=<span class="hljs-number">1</span>, --cnt[a[i]], p[++m]=a[i];<br>		<span class="hljs-keyword">if</span>(cnt[a[i]]&amp;&amp;!mpp[a[i]]) mpp[a[i]]=<span class="hljs-number">1</span>, D=<span class="hljs-number">1ll</span>*D*inv[cnt[a[i]]]%mod;<br>	&#125;<br>	nn=<span class="hljs-number">2</span>*n-m, facn=fac[nn];<br>	<span class="hljs-keyword">if</span>(m&lt;n) &#123; <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br>	<span class="hljs-keyword">if</span>(m==n) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-number">1ll</span>*facn*D%mod);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	&#125;<br>	f[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1ll</span>*facn*D%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;++i) <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=m-n&amp;&amp;j&lt;=i;++j) &#123;<br>		<span class="hljs-keyword">if</span>(!j) f[i][j]=f[i<span class="hljs-number">-1</span>][j];<br>		<span class="hljs-keyword">else</span> f[i][j]=(<span class="hljs-number">1ll</span>*f[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>]*(nn+j)%mod*<span class="hljs-built_in">rev</span>(cnt[p[i]]+<span class="hljs-number">1</span>)%mod+f[i<span class="hljs-number">-1</span>][j])%mod;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,f[m][m-n]);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="cf1806d-dsu-master">CF1806D DSU Master</h2><p>注意题目中的「排列」是 <span class="math inline">\(\{a_i\}\)</span> 的排列，而 <span class="math inline">\(\{a_i\}\)</span> 是决定 <span class="math inline">\(i\)</span> 与 <span class="math inline">\(i+1\)</span> 所在弱连通分量的连边情况的。</p><p>容易知道如果从 <span class="math inline">\(1\)</span> 连出去了任意一条边，后续的操作便不会产生贡献了。考虑到这是一个临界情况，递推之。</p><p>设 <span class="math inline">\(f_i\)</span> 为考虑操作序列 <span class="math inline">\([1,i]\)</span> 的排列，最终 <span class="math inline">\(1\)</span> 仍然没有出边的方案数。</p><p>若 <span class="math inline">\(a_i=0\)</span>，那么在 <span class="math inline">\(f_{i-1}\)</span> 中一定是从 <span class="math inline">\(i+1\)</span> 连向 <span class="math inline">\(1\)</span>，随便放即可。</p><p>否则 <span class="math inline">\(1\)</span> 一定不能是 <span class="math inline">\(i\)</span> 所在弱连通分量的无出边点，考虑在 <span class="math inline">\(f_{i-1}\)</span> 中，若 <span class="math inline">\(a_1\)</span> 在最后面，那么只要放到除了 <span class="math inline">\(a_1\)</span> 后面的 <span class="math inline">\(i-1\)</span> 个位置即可。</p><p>否则设 <span class="math inline">\(a_1\)</span> 的位置是 <span class="math inline">\(p\)</span>，在这之前的所有位置可以任选。考虑操作排列 <span class="math inline">\([p,i-1]\)</span> 内一定不存在从 <span class="math inline">\(1\)</span> 所在弱连通分量 <span class="math inline">\(G&#39;\)</span> 连出去的边，因此要么是连入 <span class="math inline">\(G&#39;\)</span> 的边，要么是相对孤立的两个点连边，此时证明 <span class="math inline">\(i-1 \notin G&#39;\)</span>。</p><blockquote><p>假设如此，那么如果 <span class="math inline">\(i-1\)</span> 连入了 <span class="math inline">\(G&#39;\)</span>，那么一定有 <span class="math inline">\(i-2 \in G&#39;\)</span> 中，进而 <span class="math inline">\(i-3 \in G&#39;\)</span>。由此递归下去得到此时必须连完了所有边，与 <span class="math inline">\(p \neq i-1\)</span> 矛盾。</p></blockquote><p>由于 <span class="math inline">\(i-1 \notin G&#39;\)</span>，所以 <span class="math inline">\(a_i\)</span> 不影响 <span class="math inline">\(1\)</span>，仅仅不能放在最后一个位置，方案仍然是 <span class="math inline">\(i-1\)</span>。</p><p>于是</p><p><span class="math display">\[ f_i= \begin{cases} f_{i-1} \cdot i &amp; a_i = 0 \\ f_{i-1} \cdot (i-1) &amp; a_i =1\end{cases} \]</span></p><p>考虑统计答案，设 <span class="math inline">\(ans_i\)</span> 为 <span class="math inline">\([1,i]\)</span> 的贡献。考虑 <span class="math inline">\(ans_{i-1} \rightarrow ans_i\)</span>，首先把 <span class="math inline">\(a_i\)</span> 扔到里面任何位置不会改变原有的贡献。其次如果 <span class="math inline">\(a_i = 0\)</span>，那么有 <span class="math inline">\(f_{i-1}\)</span> 种方法使得 <span class="math inline">\(ans_{i-1}\)</span> 贡献 <span class="math inline">\(f_{i-1}\)</span> 个 <span class="math inline">\(1\)</span> 出去；而当 <span class="math inline">\(a_i = 1\)</span> 时，无论如何都无法使得 <span class="math inline">\(1\)</span> 的入边增加。</p><p><span class="math display">\[ ans_i = ans_{i-1} \cdot i + (1-a_i) \cdot f_{i-1} \]</span></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Record/" class="category-chain-item">Record</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E8%AE%A1%E6%95%B0/" class="print-no-link">#计数</a> <a href="/tags/DP/" class="print-no-link">#DP</a> <a href="/tags/%E7%BB%84%E5%90%88%E6%95%B0%E5%AD%A6/" class="print-no-link">#组合数学</a> <a href="/tags/%E4%BA%8C%E9%A1%B9%E5%BC%8F%E5%8F%8D%E6%BC%94/" class="print-no-link">#二项式反演</a></div></div><div class="license-box my-3"><div class="license-title"><div>「NOIP Record」#7 计数杂题 (2)</div><div>https://yozora0908.top/2023/noip-record-7/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>如月あかり</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年6月20日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/lg7386-solution/" title="luogu7386「EZEC-6」0-1 Trie 题解"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">luogu7386「EZEC-6」0-1 Trie 题解</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/noip-record-6/" title="「NOIP Record」#6 计数杂题 (1)"><span class="hidden-mobile">「NOIP Record」#6 计数杂题 (1)</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"KinomiyaAgeha/MyGiscus","repo-id":"R_kgDOLRRFyQ","category":"Announcements","category-id":"DIC_kwDOLRRFyc4CdJ34","theme-light":"light_protanopia","theme-dark":"dark_protanopia","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","loading":"lazy","strict":1};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light_protanopia';
        var dark = 'dark_protanopia';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script>if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });</script><script src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>