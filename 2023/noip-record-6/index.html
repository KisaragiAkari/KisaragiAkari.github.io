<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn-jp.imgs.moe/2023/09/07/64f916e42a582.png"><link rel="icon" href="https://cdn-jp.imgs.moe/2023/09/07/64f916e42a582.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#003153"><meta name="author" content="KisaragiQwQ"><meta name="keywords" content="OI"><meta name="description" content="计数杂题。 CF840C On the Bench 先进行一些基本的观察。 \(\texttt{Observation}\) \(\{a_i\}\) 中乘积为完全平方数的数集，一定是相对封闭的。因此我们可以将 \(\{a_i\}\) 划分成若干个集合，满足其中两两乘积为完全平方数。 \(\texttt{proof}\)  考虑和 \(a_i\) 相乘为完全平方数的数集 \(\{"><title>「NOIP Record」#6 计数杂题 (1) - Kisaragi&#39;s blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"yozora0908.top",root:"/",version:"1.9.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"#"},progressbar:{enable:!0,height_px:3,color:"#0076FF",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:null,onlypost:!0,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!1,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.1.0"><link rel="alternate" href="/atom.xml" title="Kisaragi's blog" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kisaragi&#39;s blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn-jp.imgs.moe/2023/09/07/64f916e5da678.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">「NOIP Record」#6 计数杂题 (1)</span></div><div class="mt-3"></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">「NOIP Record」#6 计数杂题 (1)</h1><div class="markdown-body"><p>计数杂题。</p><h2 id="cf840c-on-the-bench">CF840C On the Bench</h2><p>先进行一些基本的观察。</p><p><span class="math inline">\(\texttt{Observation}\)</span></p><p><span class="math inline">\(\{a_i\}\)</span> 中乘积为完全平方数的数集，一定是相对封闭的。因此我们可以将 <span class="math inline">\(\{a_i\}\)</span> 划分成若干个集合，满足其中两两乘积为完全平方数。</p><p><span class="math inline">\(\texttt{proof}\)</span></p><blockquote><p>考虑和 <span class="math inline">\(a_i\)</span> 相乘为完全平方数的数集 <span class="math inline">\(\{a_j\}\)</span>。由于一个数是完全平方数的充要条件是所有质因子的次幂都是 <span class="math inline">\(2\)</span> 的倍数，因此 <span class="math inline">\(\{a_j\}\)</span> 中任意数的质因子次数都和 <span class="math inline">\(a_i\)</span> 同奇偶，进而它们两两同奇偶。不在 <span class="math inline">\(\{a_j\}\)</span> 中的数则与集合内任何数相乘都不是完全平方数。</p></blockquote><p>有了这个性质，那么相邻两个元素乘积不为完全平方数的条件，等价于同一个集合的元素不能相邻。</p><p>考虑每个集合中编号最小的那个元素作为代表元素，排序，处理这个东西的所有排列。显然是个双射。</p><p>设 <span class="math inline">\(f_{i,j,k}\)</span> 为考虑 <span class="math inline">\([1,i]\)</span> 的排列，当前集合有 <span class="math inline">\(k\)</span> 对相邻，其他集合有 <span class="math inline">\(j\)</span> 对同集合且相邻的方案数。</p><p>设 <span class="math inline">\(b_i\)</span> 为 <span class="math inline">\(i\)</span> 位置上的代表元素，同时维护 <span class="math inline">\(cnt\)</span> 为当前集合放好了多少个元素。</p><p>如果 <span class="math inline">\(b_i = b_{i-1}\)</span>，枚举 <span class="math inline">\(j\)</span> 和 <span class="math inline">\(k\)</span></p><ul><li><p>放到本集合元素旁边。除了靠在一起的 <span class="math inline">\(k-1\)</span> 个位置，其他每个 <span class="math inline">\(b_i\)</span> 集合元素的位置都有两种方案。 <span class="math display">\[ f_{i-1,j,k-1} \cdot (2cnt - k+1) \rightarrow f_{i,j,k} \]</span></p></li><li><p>放到其他集合元素旁边，干掉相邻同集合的。显然只能减少一个 <span class="math display">\[ f_{i-1,j+1,k} \cdot (j+1) \rightarrow f_{i,j,k} \]</span></p></li><li><p>放到其他集合元素旁边，不干掉相邻同集合的。本集合元素两边都不能放，但是还要减去被相邻元素干掉的 <span class="math inline">\(k\)</span> 与 <span class="math inline">\(j\)</span> 个位置。方案数 <span class="math inline">\(i-(2cnt-k) - j\)</span></p><p><span class="math display">\[ f_{i-1,j,k} \cdot \Big(i-(2cnt-k)-j \Big) \rightarrow f_{i,j,k} \]</span></p></li></ul><p>否则 <span class="math inline">\(b_i \neq b_{i-1}\)</span>，说明换了下一个集合，令 <span class="math inline">\(cnt \leftarrow 0\)</span>。枚举 <span class="math inline">\(j\)</span> 和上一个集合的 <span class="math inline">\(k\)</span></p><ul><li><p>不干掉相邻同集合的 <span class="math display">\[ f_{i-1,k,j-k} \cdot (i-j) \rightarrow f_{i,j,0} \]</span></p></li><li><p>干掉相邻同集合的 <span class="math display">\[ f_{i-1,k,j-k+1} \cdot (j+1) \rightarrow f_{i,j,0} \]</span></p></li></ul><p>答案是 <span class="math inline">\(f_{n,0,0}\)</span></p><p>复杂度 <span class="math inline">\(O(n^3)\)</span>，而且过程相当复杂啊。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">305</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> n, a[N], b[N], f[N][N][N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">squ</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-type">int</span> t=<span class="hljs-built_in">sqrt</span>(x*y);<br>	<span class="hljs-keyword">if</span>(t*t==x*y) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) a[i]=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) &#123;<br>		b[i]=i;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;i;++j) <span class="hljs-keyword">if</span>(<span class="hljs-built_in">squ</span>(a[i],a[j])) &#123;<br>			b[i]=j; <span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(b+<span class="hljs-number">1</span>,b+n+<span class="hljs-number">1</span>);<br>	f[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> cnt=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) &#123;<br>		<span class="hljs-keyword">if</span>(b[i]==b[i<span class="hljs-number">-1</span>]) &#123;<br>			<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">0</span>,i<span class="hljs-number">-1</span>) <span class="hljs-built_in">rep</span>(k,<span class="hljs-number">0</span>,cnt) &#123;<br>				<span class="hljs-keyword">if</span>(k) (f[i][j][k]+=f[i<span class="hljs-number">-1</span>][j][k<span class="hljs-number">-1</span>]*(<span class="hljs-number">2</span>*cnt-k+<span class="hljs-number">1</span>)%mod)%=mod;<br>				(f[i][j][k]+=f[i<span class="hljs-number">-1</span>][j+<span class="hljs-number">1</span>][k]*(j+<span class="hljs-number">1</span>)%mod)%=mod;<br>				(f[i][j][k]+=f[i<span class="hljs-number">-1</span>][j][k]*(i<span class="hljs-number">-2</span>*cnt+k-j)%mod)%=mod;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			cnt=<span class="hljs-number">0</span>;<br>			<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">0</span>,i<span class="hljs-number">-1</span>) <span class="hljs-built_in">rep</span>(k,<span class="hljs-number">0</span>,j+<span class="hljs-number">1</span>) &#123;<br>				<span class="hljs-keyword">if</span>(k&lt;=j) (f[i][j][<span class="hljs-number">0</span>]+=f[i<span class="hljs-number">-1</span>][k][j-k]*(i-j)%mod)%=mod;<br>				(f[i][j][<span class="hljs-number">0</span>]+=f[i<span class="hljs-number">-1</span>][k][j-k+<span class="hljs-number">1</span>]*(j+<span class="hljs-number">1</span>)%mod)%=mod;<br>			&#125;<br>		&#125;<br>		++cnt;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,f[n][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>   </p><p>有更优秀的容斥做法。</p><p>设一共有 <span class="math inline">\(m\)</span> 个集合，第 <span class="math inline">\(i\)</span> 个集合的大小是 <span class="math inline">\(s_i\)</span>，每个集合内部元素带标号。</p><p>先不考虑限制，设第 <span class="math inline">\(i\)</span> 个集合分成 <span class="math inline">\(b_i\)</span> 段，<span class="math inline">\(B=\sum_{i=1}^m b_i\)</span>，那么所有集合全排列的方案是 <span class="math display">\[ \frac{B!}{\prod_{i=1}^m (b_i !)} \prod_{i=1}^m s_i! \binom{s_i-1}{b_i-1} \]</span></p><p><span class="math display">\[ \prod_{i=1}^m (s_i !) B!\prod_{i=1}^m \frac{1}{b_i!} \binom{s_i-1}{b_i-1} \]</span></p><p><span class="math inline">\(B\)</span> 可以枚举，但 <span class="math inline">\(\sum_{i=1}^m b_i = B\)</span> 是卷积。</p><p><span class="math inline">\(\texttt{Obervation}\)</span></p><p>考虑这样一个事情。</p><p>我们要求的是「对于每一个集合，其元素两两不相邻」的方案数。如果 <span class="math inline">\(B=n\)</span>，那么相当于至少有 <span class="math inline">\(0\)</span> 个和自己集合元素相邻的元素，<span class="math inline">\(B=n-1\)</span> 时则是至少有 <span class="math inline">\(1\)</span> 个。于是可以就此容斥。</p><p>枚举 <span class="math inline">\(B \in [m,n]\)</span>，如何处理 <span class="math inline">\(\prod_{i=1}^m\frac{1}{b_i!} \binom{s_i-1}{b_i -1}\)</span> 呢？</p><p>设 <span class="math inline">\(f_{i,j}\)</span> 为 <span class="math inline">\([1,i]\)</span> 中的集合，划分的总段数不超过 <span class="math inline">\(j\)</span> 时候，上面式子的值。 <span class="math display">\[ f_{i,j} = \sum_{k \in [1,\min(s_i,j)]} \binom{s_i-1}{k-1} f_{i-1,j-k} \cdot \frac{1}{k!} \]</span> 限制了 <span class="math inline">\(j \in [1,\sum_{i=1}^i s_i]\)</span> 与 <span class="math inline">\(k \in [1,\min(s_i,j)]\)</span>，复杂度是 <span class="math inline">\(O(n^2)\)</span> 的。</p><p>然后上面式子带上个 <span class="math inline">\((-1)^{n-i}\)</span> 的系数即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">305</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> n, m, ans, a[N], t[N], s[N], fac[N], inv[N], f[N][N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fp</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	<span class="hljs-type">int</span> c=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;a=a*a%mod,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=c*a%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>	fac[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,<span class="hljs-number">300</span>) fac[i]=fac[i<span class="hljs-number">-1</span>]*i%mod;<br>	inv[<span class="hljs-number">300</span>]=<span class="hljs-built_in">fp</span>(fac[<span class="hljs-number">300</span>],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-built_in">per</span>(i,<span class="hljs-number">299</span>,<span class="hljs-number">1</span>) inv[i]=inv[i+<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)%mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> n,<span class="hljs-type">int</span> m)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;m) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(n==m) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> fac[n]*inv[m]%mod*inv[n-m]%mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">squ</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-type">int</span> t=<span class="hljs-built_in">sqrt</span>(x*y);<br>	<span class="hljs-keyword">if</span>(t*t==x*y) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) a[i]=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) &#123;<br>		<span class="hljs-type">int</span> fg=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">1</span>,m) &#123;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-built_in">squ</span>(a[i],t[j])) &#123; ++s[j], fg=<span class="hljs-number">1</span>; <span class="hljs-keyword">break</span>; &#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!fg) t[++m]=a[i], s[m]=<span class="hljs-number">1</span>;<br>	&#125;<br>    <span class="hljs-comment">// 预处理</span><br>	<span class="hljs-built_in">init</span>();<br>	f[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> S=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,m) &#123;<br>		S+=s[i];<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">1</span>,S) <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=s[i]&amp;&amp;k&lt;=j;++k) (f[i][j]+=f[i<span class="hljs-number">-1</span>][j-k]*<span class="hljs-built_in">C</span>(s[i]<span class="hljs-number">-1</span>,k<span class="hljs-number">-1</span>)%mod*inv[k]%mod)%=mod;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,m,n) &#123;<br>		<span class="hljs-keyword">if</span>((n-i)&amp;<span class="hljs-number">1</span>) (ans-=f[m][i]*fac[i]%mod-mod)%=mod; <span class="hljs-keyword">else</span> (ans+=f[m][i]*fac[i]%mod)%=mod;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,m) (ans*=fac[s[i]])%=mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure><p> </p><p> </p><p>另一种容斥。</p><p>设 <span class="math inline">\(f(i)\)</span> 为至少有 <span class="math inline">\(i\)</span> 个 <span class="math inline">\(k\)</span> 满足 <span class="math inline">\(a_k\)</span> 与 <span class="math inline">\(a_{k-1}\)</span> 在同一个等价类中，<span class="math inline">\(g(i)\)</span> 为恰好 <span class="math inline">\(i\)</span> 个，那么</p><p><span class="math display">\[ f(k) = \sum_{i=k}^n \binom{i}{k} g(i) \]</span></p><p><span class="math display">\[ g(k) = \sum_{i=k}^n (-1)^{i-k} \binom{i}{k} f(i) \]</span></p><p>答案是</p><p><span class="math display">\[ g(0) = \sum_{i=0}^n (-1)^i f(i) \]</span></p><p>大力搞一下可以发现</p><p><span class="math display">\[ f(k) = \sum_{k_1+k_2+ \cdots + k_m = k} \frac{(n-\sum_{i=1}^m k_i)!}{\prod_{i=1}^m \Big((s_i-k_i)!\Big)} \prod_{i=1}^m \binom{s_i - 1}{k_i} \]</span></p><p>这是个卷积形式的式子，考虑到范围不大，可以暴力求，用类似背包的方法合并 <span class="math inline">\(k_i\)</span> 即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">305</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> n, m, ans, a[N], t[N], s[N], fac[N], inv[N], f[<span class="hljs-number">2</span>][N], g[N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fp</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	<span class="hljs-type">int</span> c=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;a=a*a%mod,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=c*a%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>	fac[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,<span class="hljs-number">300</span>) fac[i]=fac[i<span class="hljs-number">-1</span>]*i%mod;<br>	inv[<span class="hljs-number">300</span>]=<span class="hljs-built_in">fp</span>(fac[<span class="hljs-number">300</span>],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-built_in">per</span>(i,<span class="hljs-number">299</span>,<span class="hljs-number">1</span>) inv[i]=inv[i+<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)%mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> n,<span class="hljs-type">int</span> m)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;m) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(n==m) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> fac[n]*inv[m]%mod*inv[n-m]%mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">squ</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-type">int</span> t=<span class="hljs-built_in">sqrt</span>(x*y);<br>	<span class="hljs-keyword">if</span>(t*t==x*y) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) a[i]=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) &#123;<br>		<span class="hljs-type">int</span> fg=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">1</span>,m) &#123;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-built_in">squ</span>(a[i],t[j])) &#123; ++s[j], fg=<span class="hljs-number">1</span>; <span class="hljs-keyword">break</span>; &#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!fg) t[++m]=a[i], s[m]=<span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-built_in">init</span>();<br>	f[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> S=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,m) &#123;<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">0</span>,S) f[<span class="hljs-number">1</span>][j]=f[<span class="hljs-number">0</span>][j], f[<span class="hljs-number">0</span>][j]=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">0</span>,s[i]<span class="hljs-number">-1</span>) &#123;<br>			g[j]=<span class="hljs-built_in">C</span>(s[i]<span class="hljs-number">-1</span>,j)*inv[s[i]-j]%mod;<br>			<span class="hljs-built_in">rep</span>(k,<span class="hljs-number">0</span>,S) (f[<span class="hljs-number">0</span>][j+k]+=g[j]*f[<span class="hljs-number">1</span>][k]%mod)%=mod;<br>		&#125;<br>		S+=s[i]<span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">0</span>,n) &#123;<br>		<span class="hljs-keyword">if</span>(i&amp;<span class="hljs-number">1</span>) (ans-=f[<span class="hljs-number">0</span>][i]*fac[n-i]%mod-mod)%=mod;<br>		<span class="hljs-keyword">else</span> (ans+=f[<span class="hljs-number">0</span>][i]*fac[n-i]%mod)%=mod;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,m) (ans*=fac[s[i]])%=mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>有些映射还是可以大胆用的。</li><li>DP 外面也可以维护某些信息的，其实还是取决于 DP 的顺序。计数 DP 可以选择映射到相对容易维护信息的顺序。</li></ul><h2 id="cf1400g-mercenaries">CF1400G Mercenaries</h2><p>注意到 <span class="math inline">\(m\)</span> 很小，套路性地按照敌对关系容斥。</p><p>枚举集合 <span class="math inline">\(S\)</span> 表示至少满足存在 <span class="math inline">\(S\)</span> 集合内所有敌对关系的方案数。</p><p>然后对于敌对关系内的每个人，能够求出他们条件区间的交。只要集合大小在这个交区间 <span class="math inline">\([l,r]\)</span> 内就能满足条件。</p><p>注意到所谓条件区间，覆盖的其实是集合大小。</p><p>考虑差分求出所有条件区间的覆盖情况，设 <span class="math inline">\(d_j\)</span> 为大小为 <span class="math inline">\(j\)</span> 的集合能满足其条件区间的人数。</p><p>设 <span class="math inline">\(g_{i,j}\)</span> 表示选出钦定的 <span class="math inline">\(i\)</span> 个人后，至多选择 <span class="math inline">\(j\)</span> 个人的方案数。 <span class="math display">\[ g_{i,j} = g_{i,j-1} + \binom{d_j-i}{j-i} \]</span> 然后设 <span class="math inline">\(c\)</span> 表示 <span class="math inline">\(S\)</span> 涉及的人的数量，的贡献是 <span class="math inline">\((g_{c,R}- g_{c,L-1})\)</span>，带上一个 <span class="math inline">\((-1)^{|S|}\)</span> 的容斥系数。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e5</span>+<span class="hljs-number">5</span>, M=(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)+<span class="hljs-number">5</span>, mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n, m, U, ans, l[N], r[N], d[N], g[<span class="hljs-number">45</span>][N];<br><span class="hljs-type">int</span> fac[N], inv[N];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PII pair<span class="hljs-string">&lt;int,int&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x first</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> y second</span><br>PII p[<span class="hljs-number">25</span>]; <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fp</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	<span class="hljs-type">int</span> c=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;a=a*a%mod,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=c*a%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> n,<span class="hljs-type">int</span> m)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(n&lt;m||n&lt;<span class="hljs-number">0</span>||m&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> fac[n]*inv[m]%mod*inv[n-m]%mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>	fac[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) fac[i]=fac[i<span class="hljs-number">-1</span>]*i%mod;<br>	inv[n]=<span class="hljs-built_in">fp</span>(fac[n],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-built_in">per</span>(i,n<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>) inv[i]=inv[i+<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)%mod;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>*m) &#123;<br>		<span class="hljs-built_in">rep</span>(j,<span class="hljs-number">1</span>,n) g[i][j]=(g[i][j<span class="hljs-number">-1</span>]+<span class="hljs-built_in">C</span>(d[j]-i,j-i)%mod);<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">cc</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>&#123;<br>	<span class="hljs-type">int</span> cnt=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(x) cnt+=x&amp;<span class="hljs-number">1</span>, x&gt;&gt;=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> cnt;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>(), m=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) &#123;<br>		l[i]=<span class="hljs-built_in">read</span>(), r[i]=<span class="hljs-built_in">read</span>();<br>		++d[l[i]], --d[r[i]+<span class="hljs-number">1</span>];<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,m) p[i].x=<span class="hljs-built_in">read</span>(), p[i].y=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) d[i]+=d[i<span class="hljs-number">-1</span>];<br>	<span class="hljs-built_in">init</span>();<br>	U=(<span class="hljs-number">1</span>&lt;&lt;m)<span class="hljs-number">-1</span>;<br>	<span class="hljs-built_in">rep</span>(S,<span class="hljs-number">0</span>,U) &#123;<br>		set&lt;<span class="hljs-type">int</span>&gt; s;<br>		<span class="hljs-type">int</span> L=<span class="hljs-number">1</span>, R=n, dlt=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">0</span>,m<span class="hljs-number">-1</span>) <span class="hljs-keyword">if</span>(S&amp;(<span class="hljs-number">1</span>&lt;&lt;i)) &#123;<br>			<span class="hljs-type">int</span> x=p[i+<span class="hljs-number">1</span>].x, y=p[i+<span class="hljs-number">1</span>].y;<br>			L=<span class="hljs-built_in">max</span>(L,<span class="hljs-built_in">max</span>(l[x],l[y])), R=<span class="hljs-built_in">min</span>(R,<span class="hljs-built_in">min</span>(r[x],r[y]));<br>			s.<span class="hljs-built_in">insert</span>(x), s.<span class="hljs-built_in">insert</span>(y);<br>		&#125;<br>		<span class="hljs-type">int</span> cnt=s.<span class="hljs-built_in">size</span>();<br>		<span class="hljs-keyword">if</span>(L&lt;=R) dlt=(g[cnt][R]-g[cnt][L<span class="hljs-number">-1</span>]+mod)%mod;<br>		<span class="hljs-type">int</span> pc=<span class="hljs-built_in">cc</span>(S);<br>		<span class="hljs-keyword">if</span>(pc&amp;<span class="hljs-number">1</span>) (ans-=dlt-mod)%=mod; <span class="hljs-keyword">else</span> (ans+=dlt)%=mod;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="cf1542d-priority-queue">CF1542D Priority Queue</h2><p>首先将所谓 <span class="math inline">\(A\)</span> 的子序列转化为每个操作可选可不选。</p><p><span class="math inline">\(f(B)\)</span> 不能直接计算，可以对每个 <span class="math inline">\(x\)</span> 求贡献。具体地，计算每个 <span class="math inline">\(x\)</span> 存活到最后的方案数。</p><p>设 <span class="math inline">\(f_{i,j}\)</span> 为考虑了 <span class="math inline">\([1,i]\)</span> 的操作，<span class="math inline">\(T\)</span> 中有 <span class="math inline">\(j\)</span> 个比 <span class="math inline">\(x\)</span> 小的数的方案数。</p><p>如果 <span class="math inline">\(i\)</span> 是<code>-</code>操作，那么</p><ul><li><p>不选，方案数 <span class="math inline">\(f_{i-1,j}\)</span>。</p></li><li><p>选择此操作，删掉一个小于 <span class="math inline">\(x\)</span> 的数，方案 <span class="math inline">\(f_{i-1,j+1}\)</span>。</p></li><li><p>一个问题：如果 <span class="math inline">\(x \notin T\)</span>，排名的问题如何解决？钦定当 <span class="math inline">\(j=0\)</span> 时，<span class="math inline">\(f_{i,0}\)</span> 可以由 <span class="math inline">\(f_{i-1,0}\)</span> 转移而来。</p></li></ul><p>如果 <span class="math inline">\(i\)</span> 是<code>+ x</code>操作，那么</p><ul><li><p>不选，方案数 <span class="math inline">\(f_{i-1,j}\)</span>。</p></li><li><p>选择且 <span class="math inline">\(a_i &lt; x\)</span>，那么方案数 <span class="math inline">\(f_{i-1,j-1}\)</span>。</p></li><li><p>选择且 <span class="math inline">\(a_i &gt; x\)</span>，方案 <span class="math inline">\(f_{i-1,j}\)</span>。</p></li><li><p>一个问题：如果 <span class="math inline">\(a_i = x\)</span> 怎么办呢？如果 <span class="math inline">\(x \in T\)</span>，那么加入 <span class="math inline">\(a_i\)</span> 之后不会使 <span class="math inline">\(j\)</span> 增加，按照 <span class="math inline">\(a_i &gt; x\)</span> 的方法做显然是对的。否则呢？<span class="math inline">\(x \notin T\)</span> 时 <span class="math inline">\(T\)</span> 中等于 <span class="math inline">\(x\)</span> 的值，我们当然要让它们在 <span class="math inline">\(x\)</span> 之前被删掉，因此按照 <span class="math inline">\(a_i &lt; x\)</span> 的方法做。</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">505</span>, mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n, a[N];<br><span class="hljs-type">char</span> s[N];<br>ll f[N][N], ans;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) &#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot; %c&quot;</span>,&amp;s[i]);<br>		<span class="hljs-keyword">if</span>(s[i]==<span class="hljs-string">&#x27;-&#x27;</span>) a[i]=<span class="hljs-number">-1</span>; <span class="hljs-keyword">else</span> <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> p=<span class="hljs-number">1</span>;p&lt;=n;++p) &#123;<br>		<span class="hljs-type">int</span> x=a[p];<br>		<span class="hljs-keyword">if</span>(!~x) <span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">memset</span>(f,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(f));<br>		f[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;++i) &#123;<br>			<span class="hljs-keyword">if</span>(p==i) &#123; <span class="hljs-built_in">memcpy</span>(f[i],f[i<span class="hljs-number">-1</span>],<span class="hljs-built_in">sizeof</span>(f[i])); <span class="hljs-keyword">continue</span>; &#125;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=i;++j) &#123;<br>				<span class="hljs-keyword">if</span>(a[i]==<span class="hljs-number">-1</span>) &#123;<br>					f[i][j]=(f[i<span class="hljs-number">-1</span>][j]+f[i<span class="hljs-number">-1</span>][j+<span class="hljs-number">1</span>])%mod;<br>					<span class="hljs-keyword">if</span>(i&lt;p&amp;&amp;!j) (f[i][j]+=f[i<span class="hljs-number">-1</span>][j])%=mod;<br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a[i]&lt;x||(a[i]==x&amp;&amp;i&lt;p)) &#123;<br>					f[i][j]=f[i<span class="hljs-number">-1</span>][j];<br>					<span class="hljs-keyword">if</span>(j) (f[i][j]+=f[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>])%=mod;<br>				&#125; <span class="hljs-keyword">else</span> f[i][j]=<span class="hljs-number">2</span>*f[i<span class="hljs-number">-1</span>][j]%mod;<br>			&#125;<br>		&#125;<br>		ll sum=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=n;++i) (sum+=f[n][i])%=mod;<br>		(ans+=sum*x%mod)%=mod;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="luogu-usaco20jancave-paintings-p">luogu [USACO20JAN]Cave Paintings P</h2><p>难点在于如何合并两块空格子的信息。</p><p>不妨把连成一片的空格子称为一个连通块。对于一个连通块，初始贡献肯定是 <span class="math inline">\(1\)</span>。</p><p>考虑对于一行的连通块，必然是先向左右下合并，合并后的方案数为两个连通块方案数之积。事实上，由于这一行的初始值是 <span class="math inline">\(1\)</span>，所以相当于是把下面那一行中，能通过这一行互相到达的连通块合并了起来，由于它们是相对独立的，所以方案要做乘法。</p><p>然后呢？对于上面那一行，这一行的每个连通块必然是可选可不选，因此每一块的方案都加上 <span class="math inline">\(1\)</span>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1005</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> dx[<span class="hljs-number">4</span>]=&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;, dy[<span class="hljs-number">4</span>]=&#123;<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>&#125;;<br><span class="hljs-type">int</span> n, m, ans=<span class="hljs-number">1</span>, f[N*N], g[N*N];<br><span class="hljs-type">char</span> s[N][N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">id</span><span class="hljs-params">(<span class="hljs-type">int</span> i,<span class="hljs-type">int</span> j)</span> </span>&#123; <span class="hljs-keyword">return</span> (i<span class="hljs-number">-1</span>)*m+j; &#125;<br><span class="hljs-keyword">namespace</span> dsu &#123;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n*m;++i) f[i]=i, g[i]=<span class="hljs-number">1</span>; &#125;<br>	<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>&#123; <span class="hljs-keyword">return</span> x==f[x]? x:f[x]=<span class="hljs-built_in">get</span>(f[x]); &#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>		x=<span class="hljs-built_in">get</span>(x), y=<span class="hljs-built_in">get</span>(y);<br>		<span class="hljs-keyword">if</span>(x!=y) &#123;<br>			(g[x]*=g[y])%=mod;<br>			f[y]=x;<br>		&#125;<br>	&#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>(), m=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s[i]+<span class="hljs-number">1</span>);<br>	dsu::<span class="hljs-built_in">init</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=n<span class="hljs-number">-1</span>;i&gt;=<span class="hljs-number">2</span>;--i) &#123;<br>		map&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; v;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">2</span>;j&lt;=m<span class="hljs-number">-1</span>;++j) <span class="hljs-keyword">if</span>(s[i][j]!=<span class="hljs-string">&#x27;#&#x27;</span>) &#123;<br>			<span class="hljs-built_in">rep</span>(k,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) &#123;<br>				<span class="hljs-type">int</span> ii=i+dx[k], jj=j+dy[k];<br>				<span class="hljs-keyword">if</span>(s[ii][jj]==<span class="hljs-string">&#x27;#&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>				dsu::<span class="hljs-built_in">merge</span>(<span class="hljs-built_in">id</span>(i,j),<span class="hljs-built_in">id</span>(ii,jj));<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">2</span>;j&lt;=m<span class="hljs-number">-1</span>;++j) <span class="hljs-keyword">if</span>(s[i][j]!=<span class="hljs-string">&#x27;#&#x27;</span>) &#123;<br>			<span class="hljs-type">int</span> k=dsu::<span class="hljs-built_in">get</span>(<span class="hljs-built_in">id</span>(i,j));<br>			<span class="hljs-keyword">if</span>(!v[k]) ++g[k], v[k]=<span class="hljs-number">1</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">2</span>,n<span class="hljs-number">-1</span>) <span class="hljs-built_in">rep</span>(j,<span class="hljs-number">2</span>,m<span class="hljs-number">-1</span>) <span class="hljs-keyword">if</span>(f[<span class="hljs-built_in">id</span>(i,j)]==<span class="hljs-built_in">id</span>(i,j)) (ans*=g[<span class="hljs-built_in">id</span>(i,j)])%=mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>计算顺序对于一个计数题来说，是相当重要，且是需要着重考虑的。</li><li>虽然是有关于连通块的计数，却忽略了最关键的合并环节，同时，没有搞清楚题目中水流这个条件所具备的相对独立性与相邻两行之间的关系，思路糊成一团，反复去琢磨“样例是怎么算出来的”而非主动寻找计数的方法。</li></ul><h2 id="luogu8974-groi-r1-古朴而优雅">luogu8974 『GROI-R1』 古朴而优雅</h2><p>容易看出题面中的伪代码就是生成欧拉序的方法。</p><p>那么对于每个点 <span class="math inline">\(x\)</span>，其子节点可以任意排列，因此一棵树的答案为 <span class="math display">\[ \prod_{x} |son(x)|! \]</span> 加上边后就可能成环。手动模拟不难发现，成环之后仅仅只会让一条边访问不到，这条边就是它们 <span class="math inline">\(LCA\)</span> 分别到达它们的路径上的第一条边。</p><p>设加入的边是 <span class="math inline">\((x,y)\)</span>，<span class="math inline">\(z=LCA(x,y)\)</span>，<span class="math inline">\(z\)</span> 到 <span class="math inline">\(x\)</span> 路径上第一个节点为 <span class="math inline">\(u\)</span>，另一个为 <span class="math inline">\(v\)</span>。</p><p>如果没走 <span class="math inline">\((z,u)\)</span>，那么相当于 <span class="math inline">\(z\)</span> 少了一个子节点，<span class="math inline">\(u\)</span> 少了一个子节点，<span class="math inline">\(x\)</span> 与 <span class="math inline">\(y\)</span> 都增加了一个子节点。另一种情况同理。分别统计两种情况，加起来即可。</p><p>如何找到 <span class="math inline">\(u\)</span> 与 <span class="math inline">\(v\)</span>？树上倍增即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">5</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> n, q, ans=<span class="hljs-number">1</span>, ss[N], dep[N], f[N][<span class="hljs-number">20</span>], fac[N], inv[N];<br><span class="hljs-type">int</span> tot, h[N], to[N&lt;&lt;<span class="hljs-number">1</span>], nxt[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	to[++tot]=y, nxt[tot]=h[x], h[x]=tot;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fp</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	<span class="hljs-type">int</span> c=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;a=a*a%mod,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=c*a%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span> </span>&#123;<br>	dep[x]=dep[fa]+<span class="hljs-number">1</span>, f[x][<span class="hljs-number">0</span>]=fa;<br>	ss[x]=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,<span class="hljs-number">18</span>) f[x][i]=f[f[x][i<span class="hljs-number">-1</span>]][i<span class="hljs-number">-1</span>];<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=h[x];i;i=nxt[i]) &#123;<br>		<span class="hljs-type">int</span> y=to[i];<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		++ss[x];<br>		<span class="hljs-built_in">dfs</span>(y,x); <br>	&#125;<br>	(ans*=fac[ss[x]])%=mod;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">lca</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(dep[x]&lt;dep[y]) <span class="hljs-built_in">swap</span>(x,y);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">18</span>;~i;--i) <span class="hljs-keyword">if</span>(dep[f[x][i]]&gt;=dep[y])  x=f[x][i];<br>	<span class="hljs-keyword">if</span>(x==y) <span class="hljs-keyword">return</span> x;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">18</span>;~i;--i) &#123;<br>		<span class="hljs-keyword">if</span>(f[x][i]!=f[y][i]) x=f[x][i], y=f[y][i];<br>	&#125;<br>	<span class="hljs-keyword">return</span> f[x][<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>	fac[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) fac[i]=fac[i<span class="hljs-number">-1</span>]*i%mod;<br>	inv[n]=<span class="hljs-built_in">fp</span>(fac[n],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-built_in">per</span>(i,n<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>) inv[i]=inv[i+<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)%mod; <br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">gett</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">18</span>;~i;--i) <span class="hljs-keyword">if</span>(dep[f[x][i]]&gt;=dep[y]+<span class="hljs-number">1</span>) x=f[x][i];<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><span class="hljs-function">pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">int</span> z,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(dep[x]&gt;dep[y]) <span class="hljs-built_in">swap</span>(x,y);<br>	<span class="hljs-keyword">if</span>(x==z) <span class="hljs-keyword">return</span> &#123;y,<span class="hljs-built_in">gett</span>(y,x)&#125;;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> &#123;<span class="hljs-built_in">gett</span>(x,z),<span class="hljs-built_in">gett</span>(y,z)&#125;;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getans</span><span class="hljs-params">(<span class="hljs-type">int</span> z,<span class="hljs-type">int</span> u,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123;<br>	<span class="hljs-type">int</span> d=ans*inv[ss[z]]%mod*inv[ss[u]]%mod*inv[ss[x]]%mod*inv[ss[y]]%mod;<br>	--ss[z], --ss[u], ++ss[x], ++ss[y];<br>	(d*=fac[ss[z]]*fac[ss[u]]%mod*fac[ss[x]]%mod*fac[ss[y]]%mod)%=mod;<br>	++ss[z], ++ss[u], --ss[x], --ss[y];<br>	<span class="hljs-keyword">return</span> d;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> x=<span class="hljs-built_in">read</span>(), y=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-type">int</span> z=<span class="hljs-built_in">lca</span>(x,y);<br>	<span class="hljs-keyword">if</span>(dep[x]+dep[y]<span class="hljs-number">-2</span>*dep[z]==<span class="hljs-number">1</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; p=<span class="hljs-built_in">get</span>(z,x,y);<br>	<span class="hljs-type">int</span> u=p.first, v=p.second;<br>	<span class="hljs-type">int</span> d1=<span class="hljs-built_in">getans</span>(z,u,x,y), d2=<span class="hljs-built_in">getans</span>(z,v,x,y);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,(d1+d2)%mod);<br>	<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>(), q=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n<span class="hljs-number">-1</span>) &#123;<br>		<span class="hljs-type">int</span> x=<span class="hljs-built_in">read</span>(), y=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-built_in">add</span>(x,y), <span class="hljs-built_in">add</span>(y,x);<br>	&#125;<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">while</span>(q--) <span class="hljs-built_in">solve</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="luogu6803-ceoi2020-星际迷航">luogu6803 [CEOI2020] 星际迷航</h2><p>相当精妙的题目啊。</p><p>考虑到这 <span class="math inline">\(D+1\)</span> 棵树是相同的，我们先把一棵树的必胜必败态求出来。</p><p>设白点为先手必胜，黑点为先手必败。</p><p>加上 rt- 的前缀表明是以它为根的树中它的颜色。</p><p><span class="math inline">\(\texttt{Observation}\)</span></p><p>如果一个点连接一个 rt-白点，那么这个点的胜负情况不会改变。</p><p>如果一个点连接一个 rt-黑点，那么这个点的颜色可能改变（其实取决于对方能不能不让你走这条边）。</p><p>这个的证明是显然的。有了这个结论，<span class="math inline">\(D=1\)</span> 的情况就能做了。</p><blockquote><p>笔者自己在思考本题的时候，想法是对于先考虑一个点的颜色，再考虑连到什么样的点才必胜。这样做也不是不可以，但是有如下坏处</p><ul><li>分类讨论过细，一直在思考着必胜策略，导致做法根本无法推广到更大的 <span class="math inline">\(D\)</span> 上。</li><li>将博弈的局面分的过细。比如很多时间花在了考虑什么样的黑点连 2-黑点能够改变自己的胜负情况。</li><li>浪费了过多时间，结果也只能解决部分分。</li></ul><p>应该考虑连边的本质是换到另一个根上面，然后分连 rt-白点与 rt-黑点讨论。而犯这样的错误很大程度上是因为一开始就把自己限制在了 <span class="math inline">\(D=1\)</span> 的部分分上，导致思路受到局限。</p><p>要注意从特殊到一般，整个过程的推广并不都是可以直接套用特殊做法的。</p></blockquote><p>设 <span class="math inline">\(st_i(x)\)</span> 为以 <span class="math inline">\(i\)</span> 为根的树中，<span class="math inline">\(x\)</span> 的颜色。</p><p>称「改变颜色」为连边后的胜负情况改变，相当于这个点的颜色改变。</p><p>下面来解决改变颜色的问题。</p><p>设 <span class="math inline">\(f_i(x)\)</span> 表示以 <span class="math inline">\(i\)</span> 为根的树，在以 <span class="math inline">\(x\)</span> 为根的子树中，有多少个点满足它们连接 rt-黑点后，<span class="math inline">\(x\)</span> 的颜色改变。</p><p>先考虑以 <span class="math inline">\(1\)</span> 为根。</p><ol type="1"><li><p><span class="math inline">\(x\)</span> 的子节点全都是白点，那么 <span class="math inline">\(x\)</span> 为黑点，此时如果 <span class="math inline">\(x\)</span> 连到 2-黑点，那么 <span class="math inline">\(x\)</span> 就相当于改变成白点。否则如果任意子节点能改变为黑点，也能使 <span class="math inline">\(x\)</span> 变为白点，因此 <span class="math display">\[ f_1(x) = 1 + \sum_{y \in son(x) \text{ and } st_1(y)=1} f_1(y) \]</span></p></li><li><p>如果 <span class="math inline">\(x\)</span> 的子节点存在不止一个黑点，那么 <span class="math inline">\(x\)</span> 为白点，从而从 <span class="math inline">\(x\)</span> 连没有用。就算某个黑子节点变为白点，先手也总有其他选择，故不可能变成黑点，<span class="math inline">\(f_1(x)=0\)</span></p></li><li><p>如果 <span class="math inline">\(x\)</span> 的子节点恰好有一个黑点，那么 <span class="math inline">\(x\)</span> 为白点，从而从 <span class="math inline">\(x\)</span> 连没有用。如果那个黑点变为白点，此时 <span class="math inline">\(x\)</span> 就变成了黑点 <span class="math display">\[ f_1(x) = f_1(y) \quad y \in son(x) \text{ and } st_1(y) = 0 \]</span></p></li></ol><p>维护每个颜色子节点 <span class="math inline">\(f\)</span> 的和即可。</p><blockquote><p>犯过严重错误：没有设 <span class="math inline">\(f\)</span>，从整棵子树的角度考虑，导致得到正确的结论花了巨多时间，且不成体系。</p><p>而且有过逆天想法：万一 <span class="math inline">\(x\)</span> 连了子树外的节点怎么办呢？</p><p>实际上，如果这个点能满足 <span class="math inline">\(f\)</span> 的条件，那么连什么样的 2-黑点都相同且方案数是定值。而连接 rt-黑点后颜色能否改变，取决于这棵子树能不能使得这条边一定被经过。</p><p>没有想到求这个东西，本质上是对题目还未理解清楚。</p><p>这种逆天的担心是拖慢我做题速度的重要因素之一。</p><p>真的是太降智了啊！</p></blockquote><p><span class="math inline">\(st\)</span> 与 <span class="math inline">\(f\)</span> 均可换根 DP 在 <span class="math inline">\(O(n)\)</span> 复杂度内求出。</p><p>下面考虑 <span class="math inline">\(D=1\)</span> 时的答案。</p><p>设原树中存在 <span class="math inline">\(m\)</span> 个 <span class="math inline">\(st_x(x)=0\)</span> 的点。如果 <span class="math inline">\(st_1(1)=1\)</span>，那么答案是 <span class="math inline">\(n \times (n-m) + \Big(n-f_1(1)\Big) \times m\)</span>，否则就是 <span class="math inline">\(f_1(1) \times m\)</span>。</p><p>当 <span class="math inline">\(D=2\)</span> 时，由于第 <span class="math inline">\(1\)</span> 棵树的结点颜色可以通过第 <span class="math inline">\(2\)</span> 棵树转化，设 <span class="math inline">\(F_0\)</span> 为 <span class="math inline">\(st_x(x)=0\)</span> 的 <span class="math inline">\(x\)</span> 的答案之和，<span class="math inline">\(F_1\)</span> 类似。那么如果 <span class="math inline">\(st_1(1)=1\)</span>，答案是 <span class="math inline">\(n \times F_1 + \Big(n-f_1(1)\Big) \times F_0\)</span>，否则就是 <span class="math inline">\(f_1(1) \times F_0\)</span>。</p><p>对于 <span class="math inline">\(D &gt; 2\)</span>，是完全一样的问题。</p><p>考虑 <span class="math inline">\(F_0\)</span> 与 <span class="math inline">\(F_1\)</span> 的求法。前者要么是白点转化而来，要么是黑点不变，后者类似，因此</p><p><span class="math display">\[ F_0 = \sum_{st_x(x)=0} \Big(n-f_x(x)\Big)m + \sum_{st_x(x)=1} f_x(x)m + \sum_{st_x(x)=0} n(n-m) \]</span></p><p><span class="math display">\[ F_1 = \sum_{st_x(x)=1} \Big(n-f_x(x)\Big)m + \sum_{st_x(x)=0} f_x(x)m + \sum_{st_x(x)=1} n(n-m) \]</span></p><p>发现是一个矩阵去变换 <span class="math inline">\(\begin{bmatrix} m \\ n-m\end{bmatrix}\)</span> 这个向量 <span class="math inline">\(D-1\)</span> 次。矩阵快速幂优化即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span>+<span class="hljs-number">5</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> n, m, D, st[N], s0[N], f[N], sf[N][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> st2[N], g[N];<br>vector&lt;<span class="hljs-type">int</span>&gt; p[N];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pb emplace_back</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span> </span>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> y:p[x]) &#123;<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs</span>(y,x);<br>		s0[x]+=!st[y];<br>		sf[x][st[y]]+=f[y];<br>	&#125;<br>	st[x]=(s0[x]&gt;<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span>(s0[x]==<span class="hljs-number">1</span>) f[x]=sf[x][<span class="hljs-number">0</span>];<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s0[x]==<span class="hljs-number">0</span>) f[x]=sf[x][<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span> </span>&#123;<br>    <span class="hljs-comment">// 换根</span><br>	<span class="hljs-keyword">if</span>(!st[x]) ++m;<br>	st2[x]=st[x], g[x]=f[x];<br>	<span class="hljs-type">int</span> s0x=s0[x], stx=st[x], fx=f[x], sfx0=sf[x][<span class="hljs-number">0</span>], sfx1=sf[x][<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> y:p[x]) &#123;<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		<span class="hljs-type">int</span> s0y=s0[y], sty=st[y], fy=f[y], sfy0=sf[y][<span class="hljs-number">0</span>], sfy1=sf[y][<span class="hljs-number">1</span>];<br>		<br>		<br>		<br>		s0[x]-=!st[y];<br>		st[x]=(s0[x]&gt;<span class="hljs-number">0</span>);<br>		sf[x][st[y]]-=f[y];<br>		<span class="hljs-keyword">if</span>(s0[x]==<span class="hljs-number">1</span>) f[x]=sf[x][<span class="hljs-number">0</span>];<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s0[x]==<span class="hljs-number">0</span>) f[x]=sf[x][<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span> f[x]=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">if</span>(!st[x]) st[y]=<span class="hljs-number">1</span>, ++s0[y];<br>		sf[y][st[x]]+=f[x];<br>		<span class="hljs-keyword">if</span>(s0[y]==<span class="hljs-number">1</span>) f[y]=sf[y][<span class="hljs-number">0</span>];<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s0[y]==<span class="hljs-number">0</span>) f[y]=sf[y][<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">else</span> f[y]=<span class="hljs-number">0</span>;<br>		<span class="hljs-built_in">dfs2</span>(y,x);<br>		<br>		<br>		s0[x]=s0x, st[x]=stx, f[x]=fx, sf[x][<span class="hljs-number">0</span>]=sfx0, sf[x][<span class="hljs-number">1</span>]=sfx1;<br>		s0[y]=s0y, st[y]=sty, f[y]=fy, sf[y][<span class="hljs-number">0</span>]=sfy0, sf[y][<span class="hljs-number">1</span>]=sfy1;<br>	&#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Mat</span> &#123;<br>	<span class="hljs-type">int</span> m[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>];<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-built_in">SET</span>(m,<span class="hljs-number">0</span>); &#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123; m[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=m[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>; &#125; <br>&#125; base, ans;<br>Mat <span class="hljs-keyword">operator</span>*(Mat a,Mat b) &#123;<br>	Mat c; c.<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;++i)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">2</span>;++k)<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">2</span>;++j)<br>				(c.m[i][j]+=a.m[i][k]*b.m[k][j]%mod)%=mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><span class="hljs-function">Mat <span class="hljs-title">fp</span><span class="hljs-params">(Mat a,<span class="hljs-type">int</span> b)</span> </span>&#123;<br>	Mat c; c.<span class="hljs-built_in">clear</span>(), c.<span class="hljs-built_in">init</span>();<br>	<span class="hljs-keyword">for</span>(;b;a=a*a,b&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) c=c*a;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>(), D=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">2</span>,n) &#123;<br>		<span class="hljs-type">int</span> x=<span class="hljs-built_in">read</span>(), y=<span class="hljs-built_in">read</span>();<br>		p[x].<span class="hljs-built_in">pb</span>(y), p[y].<span class="hljs-built_in">pb</span>(x);<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x=<span class="hljs-number">1</span>;x&lt;=n;++x) &#123;<br>		<span class="hljs-keyword">if</span>(!st2[x]) &#123;<br>			(base.m[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]+=n-g[x])%=mod;<br>			(base.m[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]+=n)%=mod;<br>			(base.m[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]+=g[x])%=mod;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			(base.m[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]+=g[x])%=mod;<br>			(base.m[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]+=n-g[x])%=mod;<br>			(base.m[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]+=n)%=mod;<br>		&#125;<br>	&#125;<br>	ans.m[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=m, ans.m[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]=n-m;<br>	ans=<span class="hljs-built_in">fp</span>(base,D<span class="hljs-number">-1</span>)*ans;<br>	<span class="hljs-type">int</span> f0=ans.m[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], f1=ans.m[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>    <br>	<span class="hljs-keyword">if</span>(st[<span class="hljs-number">1</span>]) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,((n-g[<span class="hljs-number">1</span>]+mod)*f0%mod+n*f1%mod)%mod);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,g[<span class="hljs-number">1</span>]*f0%mod);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="luogu8971-groi-r1-虹色的彼岸花">luogu8971 『GROI-R1』 虹色的彼岸花</h2><p>对于题目中没有点权的那些边，显然是没有用的，删掉。</p><p>一条边 <span class="math inline">\((x,y,z)\)</span> 实际上是 <span class="math inline">\(a_x + a_y =z\)</span> 这样的一个限制。由于原图是一棵树，又删掉了若干边，得到的一定是一个森林。不难发现对于一棵树，钦定一个点为根，其他所有节点的值都能通过它来表示出来。这样就只需要考虑 <span class="math inline">\(a_{root}\)</span> 的取值了。</p><p>由于每棵树之间没有关系，所以分别求方案即可。设 <span class="math inline">\(root\)</span> 为当前树的根，节点 <span class="math inline">\(x\)</span> 的值为 <span class="math inline">\(a_x = a_{root} + \Delta\)</span>，根据 <span class="math inline">\(\Delta\)</span> 的正负取值能得到一个区间，然后与 <span class="math inline">\([l,r]\)</span> 取交即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span>+<span class="hljs-number">5</span>, mod=<span class="hljs-number">1e9</span>+<span class="hljs-number">7</span>;<br><span class="hljs-type">int</span> T, n, l, r, cnt, v[N], dep[N], c[N];<br><span class="hljs-type">int</span> tot, h[N], to[N&lt;&lt;<span class="hljs-number">1</span>], nxt[N&lt;&lt;<span class="hljs-number">1</span>], w[N&lt;&lt;<span class="hljs-number">1</span>];<br>vector&lt;<span class="hljs-type">int</span>&gt; zh[N], fu[N];<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span> </span>&#123;<br>	to[++tot]=y, w[tot]=z, nxt[tot]=h[x], h[x]=tot;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa,<span class="hljs-type">int</span> root,<span class="hljs-type">int</span> d)</span> </span>&#123;<br>	v[x]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=h[x];i;i=nxt[i]) &#123;<br>		<span class="hljs-type">int</span> y=to[i], z=w[i];<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		dep[y]=dep[x]+<span class="hljs-number">1</span>; <br>		<span class="hljs-keyword">if</span>(dep[y]%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>) fu[cnt].<span class="hljs-built_in">push_back</span>(z-d);<br>		<span class="hljs-keyword">else</span> zh[cnt].<span class="hljs-built_in">push_back</span>(z-d);<br>		<span class="hljs-built_in">dfs</span>(y,x,root,z-d);<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>(), l=<span class="hljs-built_in">read</span>(), r=<span class="hljs-built_in">read</span>();<br>	tot=cnt=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) h[i]=c[i]=dep[i]=v[i]=<span class="hljs-number">0</span>, zh[i].<span class="hljs-built_in">clear</span>(), fu[i].<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n<span class="hljs-number">-1</span>) &#123;<br>		<span class="hljs-type">int</span> op=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">if</span>(!op) <span class="hljs-type">int</span> x=<span class="hljs-built_in">read</span>(), y=<span class="hljs-built_in">read</span>();<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-type">int</span> x=<span class="hljs-built_in">read</span>(), y=<span class="hljs-built_in">read</span>(), z=<span class="hljs-built_in">read</span>();<br>			<span class="hljs-built_in">add</span>(x,y,z), <span class="hljs-built_in">add</span>(y,x,z);<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) <span class="hljs-keyword">if</span>(!v[i]) &#123;<br>		++cnt;<br>		dep[i]=<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs</span>(i,<span class="hljs-number">0</span>,i,<span class="hljs-number">0</span>);<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,cnt) &#123;<br>		<span class="hljs-keyword">if</span>(fu[i].<span class="hljs-built_in">size</span>()==<span class="hljs-number">0</span>) &#123;<br>			c[i]=r-l+<span class="hljs-number">1</span>;<br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		<span class="hljs-type">int</span> mx1=<span class="hljs-number">-1e18</span>, mx2=<span class="hljs-number">-1e18</span>, mn1=<span class="hljs-number">1e18</span>, mn2=<span class="hljs-number">1e18</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> x:zh[i]) mx1=<span class="hljs-built_in">max</span>(mx1,x), mn1=<span class="hljs-built_in">min</span>(mn1,x);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> x:fu[i]) mx2=<span class="hljs-built_in">max</span>(mx2,x), mn2=<span class="hljs-built_in">min</span>(mn2,x);<br>		<span class="hljs-keyword">if</span>(!zh[i].<span class="hljs-built_in">size</span>()) mx1=mn1=<span class="hljs-number">0</span>;<br>		<span class="hljs-type">int</span> L=<span class="hljs-built_in">max</span>(mx2-r,l-mn1), R=<span class="hljs-built_in">min</span>(mn2-l,r-mx1);<br>		<span class="hljs-keyword">if</span>(R&lt;L||R&lt;l||L&gt;r) c[i]=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(l&lt;=L&amp;&amp;R&lt;=r) c[i]=(R-L+<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(L&lt;l&amp;&amp;R&lt;=r) c[i]=(R-l+<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(R&gt;r&amp;&amp;l&lt;=L) c[i]=(r-L+<span class="hljs-number">1</span>);<br>	&#125;<br>	<span class="hljs-type">int</span> ans=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,cnt) (ans*=c[i])%=mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	T=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">while</span>(T--) <span class="hljs-built_in">solve</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="luogu7717-ezec-10序列">luogu7717 「EZEC-10」序列</h2><p><a href="https://yozora0908.top/2023/lg7717-solution">link</a></p><h2 id="luogu4063-jxoi2017数列">luogu4063 [JXOI2017]数列</h2><p>设 <span class="math inline">\(L_i\)</span> 为第 <span class="math inline">\(i+1\)</span> 个数的左边界，<span class="math inline">\(R_i\)</span> 为第 <span class="math inline">\(i+1\)</span> 个数的右边界。</p><p><span class="math inline">\(\texttt{Observation}\)</span></p><p>假定 <span class="math inline">\(L_{i-1} \neq -\infty \texttt{ and } R_{i-1} \neq \infty\)</span>。</p><p>如果 <span class="math inline">\(A_i \in [L_{i-1},A_{i-1}]\)</span>，那么将有 <span class="math inline">\(R_i = A_{i-1}\)</span>；如果 <span class="math inline">\(A_i \in [A_{i-1},R_{i-1}]\)</span>，那么将有 <span class="math inline">\(L_i = A_i\)</span>。</p><p>总之，合法取值区间必然是不断减小的。</p><p>并且取值区间的大小变化只能是边界或者上一个填的数，非常有限，但是需要分类讨论。</p><p><span class="math inline">\(\texttt{Solution}\)</span></p><p>用 <span class="math inline">\(rr_i\)</span> 代替题目中的 <span class="math inline">\(r_i\)</span>。</p><p>考虑到 <span class="math inline">\(n\)</span> 和 <span class="math inline">\(rr_i\)</span> 都很小，设 <span class="math inline">\(f(i,l,r,k)\)</span> 为考虑到了第 <span class="math inline">\(i\)</span> 个数，<span class="math inline">\(L_i = l\)</span>，<span class="math inline">\(R_i = r\)</span> 且 <span class="math inline">\(A_i = k\)</span> 的方案数。</p><p>首先要解决取值区间边界为正无穷或负无穷的问题。令 <span class="math inline">\(-\infty \rightarrow 0\)</span>，<span class="math inline">\(\infty \rightarrow \max_{i=1}^n\{rr_i\} + 1\)</span>。这两种情况，会随着取值区间缩小而消亡。</p><p>状态很多，选择使用刷表法。</p><p>对于一个 <span class="math inline">\(f(i-1,l,r,k)\)</span>，分如下几种情况讨论</p><ul><li>取值区间缩减到 <span class="math inline">\([l,l]\)</span>，那么 <span class="math inline">\(A_i \in [\max(1,l),\min(l,rr_i)]\)</span>。</li><li>取值区间缩减到 <span class="math inline">\([l,k]\)</span>，那么 <span class="math inline">\(A_i \in [l+1,\min(k-1,rr_i)]\)</span>。</li><li>取值区间缩减到 <span class="math inline">\([k,k]\)</span>，那么要求 <span class="math inline">\(A_i = A_{i-1}\)</span>，即 <span class="math inline">\(k&gt;l\)</span>，此时 <span class="math inline">\(A_i \in [k,\min(k,rr_i)]\)</span>。</li><li>取值区间缩减到 <span class="math inline">\([k,r]\)</span>，那么 <span class="math inline">\(A_i \in [k+1,\min(r-1,rr_i)]\)</span>。</li><li>取值区间缩减到 <span class="math inline">\([r,r]\)</span>，那么 <span class="math inline">\(k&lt;r\)</span>，此时 <span class="math inline">\(A_i \in [r,\min(r,rr_i)]\)</span>。</li></ul><p>以上转移在满足 <span class="math inline">\(A_i\)</span> 区间合法时，对于每个取值都加上 <span class="math inline">\(f(i-1,l,r,k)\)</span>。区间加法，差分即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET(a,b) memset(a,b,sizeof(a))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CPY(a,b) memcpy(a,b,sizeof(b))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rep(i,j,k) for(int i=(j);i&lt;=(k);++i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> per(i,j,k) for(int i=(j);i&gt;=(k);--i)</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> a=<span class="hljs-number">0</span>, f=<span class="hljs-number">1</span>; <span class="hljs-type">char</span> c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(c)) &#123;<br>		<span class="hljs-keyword">if</span>(c==<span class="hljs-string">&#x27;-&#x27;</span>) f=<span class="hljs-number">-1</span>;<br>		c=<span class="hljs-built_in">getchar</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(c)) a=a*<span class="hljs-number">10</span>+c-<span class="hljs-string">&#x27;0&#x27;</span>, c=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> a*f;<br>&#125;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">155</span>, mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n, ans, inf, rr[N], f[<span class="hljs-number">2</span>][N][N][N];<br><span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	n=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">1</span>,n) rr[i]=<span class="hljs-built_in">read</span>(), inf=<span class="hljs-built_in">max</span>(inf,rr[i]);<br>	++inf;<br>	<span class="hljs-type">int</span> p=<span class="hljs-number">0</span>;<br>	f[p][<span class="hljs-number">0</span>][inf][<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>, f[p][<span class="hljs-number">0</span>][inf][rr[<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>]=<span class="hljs-number">-1</span>+mod;<br>    <span class="hljs-comment">// 初始值</span><br>	<span class="hljs-built_in">rep</span>(i,<span class="hljs-number">2</span>,n) &#123;<br>		<span class="hljs-built_in">memset</span>(f[p^<span class="hljs-number">1</span>],<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(f[p^<span class="hljs-number">1</span>]));<br>		<span class="hljs-built_in">rep</span>(l,<span class="hljs-number">0</span>,inf) <span class="hljs-built_in">rep</span>(r,l,inf) <span class="hljs-built_in">rep</span>(k,l,r) <span class="hljs-keyword">if</span>(k<span class="hljs-number">-1</span>&gt;=<span class="hljs-number">0</span>) (f[p][l][r][k]+=f[p][l][r][k<span class="hljs-number">-1</span>])%=mod;<br>		<br>		<br>		<span class="hljs-built_in">rep</span>(l,<span class="hljs-number">0</span>,inf) <span class="hljs-built_in">rep</span>(r,l,inf) <span class="hljs-built_in">rep</span>(k,l,r) <span class="hljs-keyword">if</span>(f[p][l][r][k]) &#123;<br>			<br>			<br>			<span class="hljs-type">int</span> L=<span class="hljs-built_in">max</span>(<span class="hljs-number">1ll</span>,l), R=<span class="hljs-built_in">min</span>(l,rr[i]);<br>			<span class="hljs-type">int</span> d=f[p][l][r][k];<br>			<span class="hljs-keyword">if</span>(L&lt;=R)(f[p^<span class="hljs-number">1</span>][l][l][L]+=d)%=mod, (f[p^<span class="hljs-number">1</span>][l][l][R+<span class="hljs-number">1</span>]-=d-mod)%=mod;<br>			<br>			<br>			<span class="hljs-comment">// [l,l]</span><br>			L=l+<span class="hljs-number">1</span>, R=<span class="hljs-built_in">min</span>(k<span class="hljs-number">-1</span>,rr[i]);<br>			<span class="hljs-keyword">if</span>(L&lt;=R) (f[p^<span class="hljs-number">1</span>][l][k][L]+=d)%=mod, (f[p^<span class="hljs-number">1</span>][l][k][R+<span class="hljs-number">1</span>]-=d-mod)%=mod;<br>			<span class="hljs-comment">// [l+1,k-1]</span><br>			<br>			<span class="hljs-keyword">if</span>(k&gt;l) &#123;<br>				L=<span class="hljs-built_in">max</span>(k,<span class="hljs-number">1ll</span>), R=<span class="hljs-built_in">min</span>(k,rr[i]);<br>				<span class="hljs-keyword">if</span>(L&lt;=R) (f[p^<span class="hljs-number">1</span>][k][k][L]+=d)%=mod, (f[p^<span class="hljs-number">1</span>][k][k][R+<span class="hljs-number">1</span>]-=d-mod)%=mod;<br>			&#125;<br>			<span class="hljs-comment">// a[i]=a[i-1] [k,k];</span><br>			<br>			<br>			L=k+<span class="hljs-number">1</span>, R=<span class="hljs-built_in">min</span>(r<span class="hljs-number">-1</span>,rr[i]);<br>			<span class="hljs-keyword">if</span>(L&lt;=R) (f[p^<span class="hljs-number">1</span>][k][r][L]+=d)%=mod, (f[p^<span class="hljs-number">1</span>][k][r][R+<span class="hljs-number">1</span>]-=d-mod)%=mod;<br>			<span class="hljs-comment">// [k+1,r-1]</span><br>			<br>			<span class="hljs-keyword">if</span>(k&lt;r) &#123;<br>				L=<span class="hljs-built_in">max</span>(r,<span class="hljs-number">1ll</span>), R=<span class="hljs-built_in">min</span>(r,rr[i]);<br>				<span class="hljs-keyword">if</span>(L&lt;=R) (f[p^<span class="hljs-number">1</span>][r][r][L]+=d)%=mod, (f[p^<span class="hljs-number">1</span>][r][r][R+<span class="hljs-number">1</span>]-=d-mod)%=mod;<br>			&#125;<br>			<span class="hljs-comment">// [r,r]</span><br>		&#125;<br>		p^=<span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-built_in">rep</span>(l,<span class="hljs-number">0</span>,inf) <span class="hljs-built_in">rep</span>(r,l,inf) <span class="hljs-built_in">rep</span>(k,l,r) &#123;<br>		(f[p][l][r][k]+=f[p][l][r][k<span class="hljs-number">-1</span>])%=mod;<br>		(ans+=f[p][l][r][k])%=mod;<br>		<span class="hljs-comment">// printf(&quot;%lld\n&quot;,f[n][l][r][k]);</span><br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans);<br>&#125;<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Record/" class="category-chain-item">Record</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E8%AE%A1%E6%95%B0/" class="print-no-link">#计数</a> <a href="/tags/DP/" class="print-no-link">#DP</a> <a href="/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/" class="print-no-link">#并查集</a> <a href="/tags/%E7%BB%84%E5%90%88%E6%95%B0%E5%AD%A6/" class="print-no-link">#组合数学</a> <a href="/tags/%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86/" class="print-no-link">#容斥原理</a> <a href="/tags/%E6%A0%91%E5%BD%A2DP/" class="print-no-link">#树形DP</a> <a href="/tags/Trie/" class="print-no-link">#Trie</a> <a href="/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA/" class="print-no-link">#博弈论</a> <a href="/tags/%E7%9F%A9%E9%98%B5/" class="print-no-link">#矩阵</a> <a href="/tags/%E4%BA%8C%E9%A1%B9%E5%BC%8F%E5%8F%8D%E6%BC%94/" class="print-no-link">#二项式反演</a></div></div><div class="license-box my-3"><div class="license-title"><div>「NOIP Record」#6 计数杂题 (1)</div><div>https://yozora0908.top/2023/noip-record-6/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>KisaragiQwQ</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年6月20日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/noip-record-7/" title="「NOIP Record」#7 计数杂题 (2)"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">「NOIP Record」#7 计数杂题 (2)</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/noip-record-5/" title="「NOIP Record」#5 倍增"><span class="hidden-mobile">「NOIP Record」#5 倍增</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="giscus" class="giscus"></div><script type="text/javascript">Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"yozora0908/MyGiscus","repo-id":"R_kgDOKLq9Ag","category":"Announcements","category-id":"DIC_kwDOKLq9As4CY38c","theme-light":"light_protanopia","theme-dark":"dark_protanopia","mapping":"title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN","loading":"lazy","strict":1};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light_protanopia';
        var dark = 'dark_protanopia';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script>if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });</script><script src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>